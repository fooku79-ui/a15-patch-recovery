name: RECOVERY
on:
  workflow_dispatch:
    inputs:
      RECOVERY_URL:
        description: "Direct Google Drive download link (uc?export=download&id=...)"
        required: true
      IMAGE_NAME:
        description: "Base name for outputs (no extension)"
        required: false
        default: "patched-recovery"

jobs:
  patch-recovery:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            lz4 zip unzip tar coreutils p7zip-full git xz-utils gawk sed grep file curl openssl
            
      - name: Prepare workspace
        run: |
          set -euxo pipefail
          mkdir -p work/in work/out
          echo "${{ github.event.inputs.RECOVERY_URL }}" > work/URL.txt
          
      - name: Download and validate recovery image
        run: |
          set -euxo pipefail
          URL="$(cat work/URL.txt)"
          cd work/in
          echo "ðŸ“¥ Downloading: $URL"
          curl -L --fail --retry 4 --connect-timeout 20 "$URL" -o recovery.img
          
          echo "ðŸ” Checking file type..."
          file recovery.img | tee ../recovery.file.txt
          sha256sum recovery.img | tee ../recovery.sha256.txt
          
          # Decompress if LZ4
          case "$(file -b recovery.img)" in
            *LZ4*) 
              echo "ðŸ§© Detected LZ4 compression. Decompressing..."
              lz4 -d -f recovery.img recovery.raw.img
              ;;
            *)
              echo "ðŸ“¦ No compression detected. Copying as-is..."
              cp -f recovery.img recovery.raw.img
              ;;
          esac
          
          echo "ðŸ” Validating decompressed image..."
          file recovery.raw.img | tee ../recovery.raw.file.txt
          
          # Fixed validation - handles both "Android boot image" and "Android bootimg" formats
          if ! file recovery.raw.img | grep -q -E "(Android boot|Android bootimg)"; then
            echo "âŒ Not a valid Android recovery image." >&2
            echo "File type detected: $(file -b recovery.raw.img)" >&2
            exit 2
          fi
          
          echo "âœ… Valid Android recovery image detected!"
          
          # Replace original for downstream steps
          mv -f recovery.raw.img recovery.img
          
      - name: Download AIK-Linux
        run: |
          set -euxo pipefail
          cd work
          echo "ðŸ“¥ Downloading AIK-Linux as ZIP..."
          curl -L --fail --retry 3 --connect-timeout 20 \
            "https://github.com/osm0sis/AIK-Linux/archive/main.zip" -o AIK.zip
          
          echo "ðŸ“¦ Extracting AIK-Linux..."
          unzip -q AIK.zip
          mv AIK-Linux-main AIK
          rm AIK.zip
          
          # Verify download succeeded
          if [ ! -d AIK ] || [ ! -f AIK/unpackimg.sh ]; then
            echo "âŒ Failed to download or extract AIK-Linux" >&2
            exit 1
          fi
          
          # Make scripts executable
          chmod +x AIK/*.sh
          echo "âœ… AIK-Linux downloaded and extracted successfully"
          
      - name: Unpack recovery
        run: |
          set -euxo pipefail
          cd work/AIK
          cp -f ../in/recovery.img ./recovery.img
          bash cleanup.sh || true
          bash unpackimg.sh ./recovery.img
          
          # Verify unpacking succeeded
          if [ ! -d ramdisk ]; then
            echo "âŒ Unpack failed: no ramdisk directory found." >&2
            echo "Contents of AIK directory:" >&2
            ls -la . >&2
            exit 3
          fi
          
          echo "âœ… Recovery image unpacked successfully!"
          
      - name: Patch recovery
        run: |
          set -euxo pipefail
          if [ ! -f scripts/enable_fastbootd.sh ]; then
            echo "âŒ Patch script not found: scripts/enable_fastbootd.sh" >&2
            exit 4
          fi
          
          chmod +x scripts/enable_fastbootd.sh
          ./scripts/enable_fastbootd.sh work/AIK
          echo "âœ… Recovery patching completed!"
          
      - name: Repack recovery
        run: |
          set -euxo pipefail
          cd work/AIK
          bash repackimg.sh
          
          if [ ! -f image-new.img ]; then
            echo "âŒ Repack failed: image-new.img not found." >&2
            echo "Contents of AIK directory:" >&2
            ls -la . >&2
            exit 5
          fi
          
          mv -f image-new.img ../out/patched-recovery.img
          echo "âœ… Recovery image repacked successfully!"
          
      - name: Package outputs
        run: |
          set -euxo pipefail
          cd work/out
          BASENAME="${{ github.event.inputs.IMAGE_NAME }}"
          
          # Rename the main image file
          mv -f patched-recovery.img "${BASENAME}.img"
          
          # Create TAR with MD5 checksum (Odin format)
          tar --format=ustar -cf "${BASENAME}.tar" "${BASENAME}.img"
          md5sum -t "${BASENAME}.tar" | awk '{print $1}' > "${BASENAME}.tar.md5"
          cat "${BASENAME}.tar.md5" >> "${BASENAME}.tar"
          
          # Create ZIP archive
          zip -9r "${BASENAME}.zip" "${BASENAME}.img" "${BASENAME}.tar"
          
          # Copy metadata files
          cp -f ../recovery.sha256.txt .
          cp -f ../recovery.file.txt .
          cp -f ../recovery.raw.file.txt . 2>/dev/null || true
          
          echo "âœ… Output packages created!"
          echo "Files created:"
          ls -lh .
          
      - name: Upload patched recovery
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.IMAGE_NAME }}-Recovery
          path: work/out/*
          if-no-files-found: error
