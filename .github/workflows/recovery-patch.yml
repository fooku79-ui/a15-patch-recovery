name: RECOVERY

on:
  workflow_dispatch:
    inputs:
      RECOVERY_URL:
        description: "Direct download URL to recovery.img or recovery.img.lz4"
        required: true
      IMAGE_NAME:
        description: "Base name for outputs (no extension). Defaults to 'patched-recovery'"
        required: false
        default: "patched-recovery"

jobs:
  patch-recovery:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y lz4 zip unzip tar md5sum

      - name: Download recovery
        run: |
          mkdir -p work
          cd work
          curl -L "${{ github.event.inputs.RECOVERY_URL }}" -o recovery.img.lz4 || \
          curl -L "${{ github.event.inputs.RECOVERY_URL }}" -o recovery.img
          if [ -f recovery.img.lz4 ]; then
            lz4 -d recovery.img.lz4 recovery.img
          fi

      - name: Patch placeholder
        run: |
          echo ">>> This is where enable_fastbootd.sh would modify ramdisk <<<"

      - name: Package outputs
        run: |
          cd work
          BASENAME="${{ github.event.inputs.IMAGE_NAME }}"
          cp recovery.img "${BASENAME}.img"
          tar --format=ustar -cf "${BASENAME}.tar" "${BASENAME}.img"
          md5sum -t "${BASENAME}.tar" | awk '{print $1}' > "${BASENAME}.tar.md5"
          cat "${BASENAME}.tar.md5" >> "${BASENAME}.tar"
          zip -9r "${BASENAME}.zip" "${BASENAME}.img" "${BASENAME}.tar"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Patched-Recovery
          path: work/*
